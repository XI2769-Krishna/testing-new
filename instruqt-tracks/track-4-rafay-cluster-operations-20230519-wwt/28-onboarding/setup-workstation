#/bin/bash
set -exo pipefail

cat <<EOF > onboarding.sh
#!/bin/bash

# Prompt the user for email
printf "Enter your email: "
read EMAIL

# Prompt the user for first name
printf "Enter your first name: "
read FIRSTNAME

# Prompt the user for last name
printf "Enter your last name: "
read LASTNAME
printf "\n"

# Begin error checking
if ! [[ "\$EMAIL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}$ ]]; then
echo "Error: Please enter a valid email address"
exit 1
fi

if [[ ! "\$FIRSTNAME" =~ ^[a-zA-Z-]+$ ]]; then
echo "Error: First name must contain alphabets or hyphens"
exit 1
fi

if [[ ! "\$LASTNAME" =~ ^[a-zA-Z-]+$ ]]; then
echo "Error: Last name must contain only alphabets or hyphens"
exit 1
fi
# End error checking

echo "Gathered these:"
printf "\n"
echo "Email      = \$EMAIL"
echo "First Name = \$FIRSTNAME"
echo "Last Name  = \$LASTNAME"
printf "\n"

echo "If this does not look correct, please re-run the script."
echo "After you click Check, we will attempt to do the following:"
printf "\n"

PROJECT=\$(echo "\$EMAIL" | sed 's/\+/-43/g;s/@/-64/g;s/\./-46/g')

echo "* Onboard your account with email \$email"
echo "* Grant you ORGANIZATION ADMIN rights to your Training Organization."
echo "* Create a project named '\$PROJECT' (without the quotes). Please note this down."
echo "* Send you an email from notify-signups@rafay.co. Follow the steps in that email."
printf "\n"

echo "You will need to do all your work in the project \$PROJECT."
echo "Check scripts will be looking for this project name, so be sure that you have entered the correct info." 
printf "\n"

echo "If you made a mistake, you can re-run the onboarding.sh script."

echo \$FIRSTNAME > /tmp/firstname.txt
echo \$LASTNAME > /tmp/lastname.txt
echo \$EMAIL > /tmp/email.txt
echo \$PROJECT > /tmp/project.txt
EOF

chmod +x onboarding.sh